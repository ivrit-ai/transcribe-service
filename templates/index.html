<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{{ url_for('static', path='favicon.png') }}" />
    <title>转 注专转 ivrit.ai</title>
    <script src="https://unpkg.com/docx@9.5.1/dist/index.iife.js"></script>
    <style>
      :root {
        --bg-color: #f5f5f5;
        --container-bg: #ffffff;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --primary-color: #4caf50;
        --secondary-color: #f8f9fa;
      }

      [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --container-bg: #2d2d2d;
        --text-color: #e0e0e0;
        --border-color: #404040;
        --primary-color: #66bb6a;
        --secondary-color: #3a3a3a;
      }

      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
      }
      .container {
        background-color: var(--container-bg);
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 80%;
        max-width: 600px;
        position: relative;
      }
      .settings-btn {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background-color 0.2s;
      }
      .settings-btn:hover {
        background-color: #f0f0f0;
      }
      .settings-btn svg {
        width: 24px;
        height: 24px;
        color: #666;
      }
      .balance-container {
        display: none;
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 14px;
        color: #495057;
        text-align: right;
        z-index: 10;
      }
      .balance-container.visible {
        display: block;
      }
      .balance-label {
        font-weight: bold;
        margin-bottom: 0.25rem;
      }
      .balance-amount {
        color: #28a745;
        font-weight: bold;
      }
      .balance-loading {
        color: #6c757d;
        font-style: italic;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 2rem;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
        text-align: right;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        color: #666;
      }
      .close:hover {
        color: #000;
      }
      .form-group {
        margin-bottom: 1rem;
        text-align: left;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }
      .form-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
        text-align: left;
        direction: ltr;
      }
      .form-group input:focus {
        outline: none;
        border-color: #4caf50;
      }
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-primary {
        background-color: #4caf50;
        color: white;
      }
      .btn-secondary {
        background-color: #ccc;
        color: #333;
      }
      .btn:hover {
        opacity: 0.8;
      }
      h1 {
        margin-bottom: 2rem;
      }
      #drop-area {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        margin-bottom: 1rem;
        background-color: var(--secondary-color);
        transition: all 0.3s ease;
      }
      #drop-area:hover {
        border-color: var(--primary-color);
        background-color: rgba(76, 175, 80, 0.05);
      }
      #drop-area.highlight {
        border-color: var(--primary-color);
        background-color: rgba(76, 175, 80, 0.1);
      }
      #file-input {
        display: none;
      }
      #file-name {
        margin-top: 1rem;
        font-weight: bold;
      }
      #transcribe-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 8px;
        margin-top: 1rem;
        transition: all 0.3s ease;
      }
      #transcribe-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      }
      #transcribe-btn:disabled {
        background-color: var(--border-color);
        cursor: not-allowed;
      }
      #progress-container {
        width: 100%;
        background-color: #f0f0f0;
        border-radius: 4px;
        margin-top: 1rem;
        display: none;
      }
      #progress-bar {
        width: 0;
        height: 20px;
        background-color: #4caf50;
        border-radius: 4px;
        transition: width 0.3s;
      }
      #transcription-container {
        position: relative;
        margin: 1rem auto 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #transcription {
        width: 100%;
        height: 200px;
        border: 1px solid var(--border-color);
        padding: 1rem;
        text-align: right;
        white-space: pre-wrap;
        overflow-y: auto;
        resize: vertical;
        font-size: 1rem;
        border-radius: 8px;
        background-color: var(--container-bg);
        color: var(--text-color);
      }
      .action-buttons {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
      }
      .action-buttons button {
        background-color: var(--secondary-color);
        border: 1px solid var(--border-color);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .action-buttons button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #copy-btn {
        background-color: var(--secondary-color);
        border: 1px solid var(--border-color);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #copy-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #copy-btn svg {
        width: 20px;
        height: 20px;
        color: var(--text-color);
      }
      #download-btn {
        background-color: var(--secondary-color);
        border: 1px solid var(--border-color);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      #download-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #download-docx-btn {
        background-color: var(--secondary-color);
        border: 1px solid var(--border-color);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #download-docx-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #download-docx-btn svg {
        width: 20px;
        height: 20px;
        color: var(--text-color);
      }
      .support-link {
        margin-top: 0.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        color: #000000;
        font-weight: bold;
        transition: opacity 0.2s;
        flex-direction: row-reverse;
      }
      .support-link:hover {
        opacity: 0.8;
      }
      .support-link img {
        width: 24px;
        height: 24px;
      }
      .links-container {
        margin-top: 1.5rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-direction: column;
        align-items: center;
      }
      .contact-link {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        color: #2196f3;
        font-weight: bold;
        transition: opacity 0.2s;
        flex-direction: row-reverse;
      }
      .contact-link:hover {
        opacity: 0.8;
      }
      .contact-link svg {
        width: 24px;
        height: 24px;
      }
      .divider {
        width: 80%;
        height: 1px;
        background-color: #e0e0e0;
        margin: 1rem 0;
      }
      .display-options {
        margin-top: 1rem;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 1rem;
      }
      .slider-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #4caf50;
      }
      input:checked + .slider:before {
        transform: translateX(24px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button
        onclick="toggleTheme()"
        style="
          position: absolute;
          top: 1rem;
          right: 1rem;
          background: var(--secondary-color);
          border: 1px solid var(--border-color);
          padding: 0.5rem;
          border-radius: 8px;
          cursor: pointer;
        "
      >
        
      </button>
      <div class="balance-container" id="balance-container">
        <div class="balance-label">转专:</div>
        <div class="balance-amount" id="balance-amount">注...</div>
      </div>
      <button class="settings-btn" id="settings-btn" title="专转">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
          ></path>
        </svg>
      </button>
      <h1>转 注专转 ivrit.ai</h1>
      <div id="drop-area">
        <p>专专 拽抓   抓 专转 拽抓</p>
        <input type="file" id="file-input" accept="audio/*,video/*" />
      </div>
      <div id="file-name"></div>
      <button id="transcribe-btn" disabled>转</button>
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      <div class="action-buttons">
        <button id="copy-btn" disabled title="注转拽 转 拽住">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path
              d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
            ></path>
          </svg>
        </button>
        <button id="download-btn" disabled title="专 转转"></button>
        <button id="download-docx-btn" disabled title="专 住 Word">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
            />
            <polyline points="14,2 14,8 20,8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <polyline points="10,9 9,9 8,9" />
          </svg>
        </button>
      </div>
      <div id="transcription-container">
        <textarea id="transcription" readonly></textarea>
      </div>
      <div class="display-options">
        <span>拽住 专爪祝</span>
        <div class="slider-container">
          <label class="switch">
            <input type="checkbox" id="segment-toggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <span>驻住拽转 驻专转</span>
      </div>
      <div class="display-options">
        <label
          style="display: flex; align-items: center; gap: 8px; font-size: 16px"
        >
          <input type="checkbox" id="timecode-toggle" style="margin: 0" />
          <span>住祝 拽 </span>
        </label>
      </div>
      <div class="links-container">
        <a href="mailto:info@ivrit.ai" class="contact-link">
          <svg
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
            />
            <polyline points="22,6 12,13 2,6" />
          </svg>
          专爪 爪专 拽砖专?  
        </a>
        <a
          href="https://www.patreon.com/ivrit_ai/membership"
          target="_blank"
          class="support-link"
        >
          <img
            src="{{ url_for('static', path='patreon.png') }}"
            alt="Patreon"
          />
          专爪 转专 ?
        </a>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>专转 RunPod</h2>
          <button class="close" id="close-settings">&times;</button>
        </div>
        <form id="settings-form">
          <div class="form-group">
            <label dir="ltr" for="runpod-token">RunPod API Token:</label>
            <input
              type="password"
              id="runpod-token"
              name="runpod-token"
              placeholder="住 转 -API Token 砖"
            />
          </div>
          <div class="modal-buttons">
            <button type="button" class="btn btn-secondary" id="clear-settings">
              拽 专转
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              id="cancel-settings"
            >
              
            </button>
            <button type="submit" class="btn btn-primary">砖专</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const dropArea = document.getElementById("drop-area")
      const fileInput = document.getElementById("file-input")
      const fileName = document.getElementById("file-name")
      const transcribeBtn = document.getElementById("transcribe-btn")
      const progressContainer = document.getElementById("progress-container")
      const progressBar = document.getElementById("progress-bar")
      const transcriptionArea = document.getElementById("transcription")
      const copyBtn = document.getElementById("copy-btn")
      const downloadBtn = document.getElementById("download-btn")
      const downloadDocxBtn = document.getElementById("download-docx-btn")
      const segmentToggle = document.getElementById("segment-toggle")
      const timecodeToggle = document.getElementById("timecode-toggle")
      const settingsBtn = document.getElementById("settings-btn")
      const settingsModal = document.getElementById("settings-modal")
      const closeSettings = document.getElementById("close-settings")
      const cancelSettings = document.getElementById("cancel-settings")
      const clearSettings = document.getElementById("clear-settings")
      const settingsForm = document.getElementById("settings-form")
      const runpodTokenInput = document.getElementById("runpod-token")

      let selectedFile = null
      const MAX_FILE_SIZE = 200 * 1024 * 1024 // 200MB in bytes
      let transcriptionSegments = []
      let activeTranscription = false

      // Simple theme toggle
      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute("data-theme")
        const newTheme = currentTheme === "dark" ? "light" : "dark"
        document.documentElement.setAttribute("data-theme", newTheme)
        localStorage.setItem("theme", newTheme)
      }

      // Load saved theme
      const savedTheme = localStorage.getItem("theme") || "light"
      document.documentElement.setAttribute("data-theme", savedTheme)

      // Load settings from cookies
      function loadSettings() {
        const token = getCookie("runpod_token")
        if (token) runpodTokenInput.value = token

        // Update settings button appearance if credentials are saved
        updateSettingsButtonIndicator()
      }

      // Update settings button to show if credentials are saved
      function updateSettingsButtonIndicator() {
        const token = getCookie("runpod_token")
        const hasCredentials = token

        if (hasCredentials) {
          settingsBtn.style.color = "#4CAF50"
          settingsBtn.title = "专转 (砖专 RunPod 砖专)"
        } else {
          settingsBtn.style.color = "#666"
          settingsBtn.title = "专转"
        }
      }

      // Save settings to cookies
      async function saveSettings() {
        const token = runpodTokenInput.value.trim()

        // If token is empty, just clear the cookies
        if (!token) {
          deleteCookie("runpod_token")
          settingsModal.style.display = "none"
          updateSettingsButtonIndicator()
          return
        }

        // Show loading state
        const saveBtn = document.querySelector(
          '#settings-form button[type="submit"]'
        )
        const originalText = saveBtn.textContent
        saveBtn.textContent = "拽..."
        saveBtn.disabled = true

        try {
          // Verify credentials by checking balance
          const response = await fetch(
            `/balance?runpod_token=${encodeURIComponent(token)}`
          )
          const data = await response.json()

          if (
            response.status === 401 ||
            (response.status === 500 &&
              data.error &&
              data.error.includes("401"))
          ) {
            alert("砖: API Token  转拽")
          } else if (!response.ok) {
            alert(`砖 拽转 砖专: ${response.status}`)
          } else {
            // Credentials are valid, check endpoint
            const endpointResult = await checkAndCreateEndpoint(token)

            if (endpointResult.success) {
              // Save credentials
              setCookie("runpod_token", token, 365 * 24 * 60 * 60) // 1 year

              let successMessage = "砖专 砖专 爪!"
              if (endpointResult.needsWait) {
                successMessage +=
                  "\n\nEndpoint 砖 爪专  注.  转 3 拽转 驻 注转 拽爪."
              }

              alert(successMessage)
              settingsModal.style.display = "none"
              updateSettingsButtonIndicator()
              checkBalance() // Update balance display
            } else {
              alert(
                `砖 拽转 -endpoint: ${
                  endpointResult.error || " 转 拽  爪专 endpoint"
                }`
              )
            }
          }
        } catch (error) {
          console.error("Error verifying credentials:", error)
          if (
            error.name === "TypeError" &&
            error.message.includes("Failed to fetch")
          ) {
            alert(
              "砖:  转 转专 砖专转 RunPod.  拽 转 专 专 住 砖."
            )
          } else {
            alert("砖 拽转 砖专.  住 砖.")
          }
        } finally {
          // Restore button state
          saveBtn.textContent = originalText
          saveBtn.disabled = false
        }
      }

      // Clear settings from cookies
      function clearSettingsFromCookies() {
        deleteCookie("runpod_token")
        alert("专转 RunPod 拽 爪!")
        settingsModal.style.display = "none"
        runpodTokenInput.value = ""
        updateSettingsButtonIndicator()

        // Hide balance container when credentials are cleared
        const balanceContainer = document.getElementById("balance-container")
        balanceContainer.classList.remove("visible")
      }

      // Cookie utility functions
      function setCookie(name, value, days) {
        const expires = new Date()
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000)
        document.cookie =
          name + "=" + value + ";expires=" + expires.toUTCString() + ";path=/"
      }

      function getCookie(name) {
        const nameEQ = name + "="
        const ca = document.cookie.split(";")
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i]
          while (c.charAt(0) === " ") c = c.substring(1, c.length)
          if (c.indexOf(nameEQ) === 0)
            return c.substring(nameEQ.length, c.length)
        }
        return null
      }

      function deleteCookie(name) {
        document.cookie =
          name + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;"
      }

      // Check for RunPod credentials and fetch balance via backend API
      async function checkBalance() {
        const token = getCookie("runpod_token")

        if (token) {
          const balanceContainer = document.getElementById("balance-container")
          const balanceAmount = document.getElementById("balance-amount")

          balanceContainer.classList.add("visible")
          balanceAmount.textContent = "注..."
          balanceAmount.className = "balance-amount balance-loading"

          try {
            const response = await fetch(
              `/balance?runpod_token=${encodeURIComponent(token)}`
            )
            const data = await response.json()

            if (response.ok && data.clientBalance !== "N/A") {
              const formattedBalance = parseFloat(data.clientBalance).toFixed(2)
              balanceAmount.textContent = `$${formattedBalance}`
              balanceAmount.className = "balance-amount"
            } else {
              balanceAmount.textContent = "砖 注"
              balanceAmount.className = "balance-amount"
            }
          } catch (error) {
            console.error("Balance fetch error:", error)
            balanceAmount.textContent = "砖 注"
            balanceAmount.className = "balance-amount"
          }
        }
      }

      // Check and create endpoint if needed (called automatically when saving settings)
      async function checkAndCreateEndpoint(token) {
        try {
          const response = await fetch("/check_endpoint", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              runpod_token: token,
            }),
          })

          const data = await response.json()

          if (response.ok) {
            if (data.action === "up_to_date") {
              console.log("Endpoint is up to date")
              return { success: true, needsWait: false }
            } else if (data.action === "updated") {
              console.log("Endpoint was updated")
              return { success: true, needsWait: true }
            } else if (data.action === "created") {
              console.log("New endpoint was created")
              return { success: true, needsWait: true }
            }
          } else {
            console.error("Endpoint check failed:", data.error)
            return { success: false, error: data.error }
          }
        } catch (error) {
          console.error("Error checking endpoint:", error)
          return { success: false, error: "砖 拽转 -endpoint" }
        }
      }

      // Initialize settings button indicator on page load
      updateSettingsButtonIndicator()

      // Check balance on page load
      checkBalance()

      // Settings modal handlers
      settingsBtn.addEventListener("click", () => {
        settingsModal.style.display = "block"
        loadSettings()
      })

      closeSettings.addEventListener("click", () => {
        settingsModal.style.display = "none"
      })

      cancelSettings.addEventListener("click", () => {
        settingsModal.style.display = "none"
      })

      clearSettings.addEventListener("click", clearSettingsFromCookies)

      settingsForm.addEventListener("submit", async (e) => {
        e.preventDefault()
        await saveSettings()
        // Only close modal if save was successful (no error was shown)
        // The modal will stay open if there was an error, allowing user to fix it
      })

      // Close modal when clicking outside
      window.addEventListener("click", (e) => {
        if (e.target === settingsModal) {
          settingsModal.style.display = "none"
        }
      })
      ;["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropArea.addEventListener(eventName, preventDefaults, false)
      })

      function preventDefaults(e) {
        e.preventDefault()
        e.stopPropagation()
      }

      ;["dragenter", "dragover"].forEach((eventName) => {
        dropArea.addEventListener(eventName, highlight, false)
      })
      ;["dragleave", "drop"].forEach((eventName) => {
        dropArea.addEventListener(eventName, unhighlight, false)
      })

      function highlight() {
        dropArea.classList.add("highlight")
      }

      function unhighlight() {
        dropArea.classList.remove("highlight")
      }

      dropArea.addEventListener("drop", handleDrop, false)

      function handleDrop(e) {
        const dt = e.dataTransfer
        const files = dt.files
        handleFiles(files)
      }

      fileInput.addEventListener("change", function () {
        handleFiles(this.files)
      })

      function handleFiles(files) {
        if (files.length > 0) {
          selectedFile = files[0]
          if (selectedFile.size > MAX_FILE_SIZE) {
            alert("拽抓  .  拽住 转专  250MB.")
            selectedFile = null
            transcribeBtn.disabled = true
            fileName.textContent = ""
          } else {
            transcribeBtn.disabled = false
            fileName.textContent = `拽抓 专: ${selectedFile.name}`
          }
        }
      }

      dropArea.addEventListener("click", () => fileInput.click())

      transcribeBtn.addEventListener("click", uploadFile)

      function uploadFile() {
        if (!selectedFile) return

        const formData = new FormData()
        formData.append("file", selectedFile)

        // Add RunPod credentials if available
        const token = getCookie("runpod_token")
        if (token) {
          formData.append("runpod_token", token)
          // Show indicator that custom credentials are being used
          transcriptionArea.value = "砖转砖 砖专 RunPod 转 砖转..."
        }

        transcribeBtn.disabled = true
        progressContainer.style.display = "block"
        progressBar.style.width = "0%"
        if (!token) {
          transcriptionArea.value = "注 转 拽抓..."
        }
        transcriptionSegments = []
        copyBtn.disabled = true
        downloadBtn.disabled = true
        downloadDocxBtn.disabled = true

        const xhr = new XMLHttpRequest()
        xhr.open("POST", "/upload", true)

        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percentComplete = (event.loaded / event.total) * 100
            progressBar.style.width = percentComplete + "%"
            transcriptionArea.value = `注 转 拽抓... ${percentComplete.toFixed(
              1
            )}%`
          }
        }

        xhr.onload = function () {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText)
            if (response.error) {
              showError(response.error)
            } else {
              transcriptionArea.value = "拽抓 注. 转 转..."
              pollJobStatus(response.job_id)
            }
          } else {
            let errorMessage = undefined
            try {
              const response = JSON.parse(xhr.responseText)
              if (response.error) {
                errorMessage = response.error
              }
            } catch (e) {
              // If parsing fails, use statusText as fallback
            }

            let reportMessage = `${errorMessage}`

            if (!errorMessage) {
              const currentTime = new Date().toISOString()
              reportMessage = ` 砖 砖转,  砖  转转 info@ivrit.ai 注 驻专 :
- 转转  砖
-  砖: ${currentTime}
- 驻专 砖: ${xhr.statusText}`
            }

            showError(reportMessage)
          }
        }

        xhr.onerror = function () {
          showError("砖 注转 拽抓.  住 砖.")
        }

        xhr.send(formData)
      }

      function pollJobStatus(jobId) {
        const pollInterval = 2000 // Poll every 2 seconds

        function poll() {
          fetch(`/job_status/${jobId}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                showError(data.error)
                activeTranscription = false
                return
              }

              if (data.queue_position) {
                let statusMessage = `转专 拽 ${data.queue_position}.  砖注专 转: ${data.time_ahead}`
                if (data.job_type) {
                  let jobTypeText
                  switch (data.job_type) {
                    case "short":
                      jobTypeText = "拽爪专"
                      break
                    case "long":
                      jobTypeText = "专"
                      break
                    case "private":
                      jobTypeText = "驻专转"
                      break
                    default:
                      jobTypeText = data.job_type
                  }
                  statusMessage += `, 住 注: ${jobTypeText}`
                }
                statusMessage += `

 砖转 转,  专 砖-ivrit.ai  驻专拽  专转 专.
 砖专转 砖,  砖专转 转  转 砖转砖 专注, 转 .

  转 转专  砖 砖 转 砖专转 转专 砖转砖.

转 转专 专 拽 驻专 转转转 住.

转!`
                transcriptionArea.value = statusMessage
                progressBar.style.width = "0%"
                activeTranscription = true
                setTimeout(poll, pollInterval)
              } else if (data.progress !== undefined) {
                progressBar.style.width = `${data.progress * 100}%`
                transcriptionArea.value = `转... ${(
                  data.progress * 100
                ).toFixed(1)}%`
                activeTranscription = true

                if (data.progress < 1.0) {
                  setTimeout(poll, pollInterval)
                } else {
                  // Job is complete, update transcription display
                  transcriptionSegments = data.results
                  updateTranscriptionDisplay()
                  resetUploadState()
                  activeTranscription = false
                }
              }
            })
            .catch((error) => {
              console.error("Error:", error)
              showError("专注 砖 拽转 住住 注")
              activeTranscription = false
            })
        }

        poll()
      }

      function formatWithTimecodes(segments) {
        if (!segments || segments.length === 0) return ""

        const separator = segmentToggle.checked ? " " : "\n"
        const groups = []
        let currentGroup = []
        let currentTimeMarker = 30 // Start with 30 seconds

        for (let i = 0; i < segments.length; i++) {
          const segment = segments[i]
          currentGroup.push(segment)

          // Check if this segment should end the current group
          const shouldEndGroup =
            (segment.start <= currentTimeMarker &&
              segment.end >= currentTimeMarker) ||
            i === segments.length - 1 || // Last segment
            (i < segments.length - 1 &&
              segments[i + 1].start > currentTimeMarker)

          if (shouldEndGroup) {
            // Get start time of first segment and end time of last segment in group
            const startTime = currentGroup[0].start
            const endTime = currentGroup[currentGroup.length - 1].end

            const groupText = currentGroup
              .map((seg) => seg.text.trim())
              .join(separator)

            const formattedStartTime = formatTimeForDisplay(startTime)
            const formattedEndTime = formatTimeForDisplay(endTime)
            groups.push(
              "[" +
                formattedStartTime +
                "-" +
                formattedEndTime +
                "]\n" +
                groupText
            )

            // Reset for next group
            currentGroup = []
            currentTimeMarker += 30

            // Handle case where we need to advance time marker further
            while (
              i < segments.length - 1 &&
              segments[i + 1].start > currentTimeMarker
            ) {
              currentTimeMarker += 30
            }
          }
        }

        return groups.join("\n\n")
      }

      function formatTimeForDisplay(seconds) {
        const hours = Math.floor(seconds / 3600)
        const minutes = Math.floor((seconds % 3600) / 60)
        const secs = Math.floor(seconds % 60)

        if (hours > 0) {
          return `${hours}:${String(minutes).padStart(2, "0")}:${String(
            secs
          ).padStart(2, "0")}`
        } else {
          return `${minutes}:${String(secs).padStart(2, "0")}`
        }
      }

      function showError(message) {
        transcriptionArea.value = `砖: ${message}`
        resetUploadState()
      }

      function updateTranscriptionDisplay() {
        let result

        if (timecodeToggle.checked) {
          result = formatWithTimecodes(transcriptionSegments)
        } else {
          const separator = segmentToggle.checked ? " " : "\n"
          result = transcriptionSegments
            .map((segment) => segment.text.trim())
            .join(separator)
        }

        result = result + "\n\n" + "转 爪注转 砖专转 转 砖 ivrit.ai"

        transcriptionArea.value = result
        copyBtn.disabled = false
        downloadBtn.disabled = false
        downloadDocxBtn.disabled = false
      }

      function resetUploadState() {
        transcribeBtn.disabled = false
        selectedFile = null
        fileName.textContent = ""
        progressContainer.style.display = "none"
        progressBar.style.width = "0%"
      }

      copyBtn.addEventListener("click", function () {
        transcriptionArea.select()
        document.execCommand("copy")
        alert("拽住 注转拽 ")
      })

      downloadBtn.addEventListener("click", function () {
        if (!transcriptionSegments.length) return

        // Generate VTT content
        let vttContent = "WEBVTT\n\n"

        transcriptionSegments.forEach((segment, index) => {
          const startTime = formatTime(segment.start)
          const endTime = formatTime(segment.end)
          vttContent += `${index + 1}\n`
          vttContent += `${startTime} --> ${endTime}\n`
          vttContent += `${segment.text.trim()}\n\n`
        })

        // Create and trigger download
        const blob = new Blob([vttContent], { type: "text/vtt" })
        const url = URL.createObjectURL(blob)
        const a = document.createElement("a")
        a.href = url
        a.download = "subtitles.vtt"
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      })

      downloadDocxBtn.addEventListener("click", async function () {
        if (!transcriptionSegments.length) return

        try {
          const paragraphs = []

          // Add title
          paragraphs.push(
            new docx.Paragraph({
              children: [
                new docx.TextRun({
                  text: "转",
                  bold: true,
                  size: 32,
                  bidirectional: true,
                }),
              ],
              heading: docx.HeadingLevel.HEADING_1,
              alignment: docx.AlignmentType.RIGHT,
              bidirectional: true,
              spacing: {
                after: 400,
              },
            })
          )

          // Get the text directly from the transcription textarea
          const transcriptionText = transcriptionArea.value

          // Split the text into lines and create paragraphs
          const lines = transcriptionText
            .split("\n")
            .filter((line) => line.trim() !== "")

          lines.forEach((line) => {
            paragraphs.push(
              new docx.Paragraph({
                children: [
                  new docx.TextRun({
                    text: line,
                    size: 24,
                    bidirectional: true,
                  }),
                ],
                alignment: docx.AlignmentType.RIGHT,
                bidirectional: true,
                spacing: {
                  after: 200,
                },
                indent: {
                  right: 0,
                  left: 0,
                },
              })
            )
          })

          // Create a new document with RTL support
          const doc = new docx.Document({
            sections: [
              {
                properties: {
                  page: {
                    margin: {
                      top: 1440, // 1 inch
                      right: 1440, // 1 inch
                      bottom: 1440, // 1 inch
                      left: 1440, // 1 inch
                    },
                  },
                },
                children: paragraphs,
              },
            ],
            styles: {
              default: {
                document: {
                  run: {
                    bidirectional: true,
                  },
                },
                paragraph: {
                  alignment: docx.AlignmentType.RIGHT,
                  bidirectional: true,
                },
              },
            },
          })

          // Generate the document blob
          const buffer = await docx.Packer.toBlob(doc)

          // Download the document
          const url = URL.createObjectURL(buffer)
          const a = document.createElement("a")
          a.href = url
          a.download = "transcription.docx"

          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)

          // Clean up the URL after a short delay
          setTimeout(() => {
            URL.revokeObjectURL(url)
          }, 1000)
        } catch (error) {
          console.error("Error creating DOCX:", error)
          alert("砖 爪专转 拽抓 Word.  住 砖.")
        }
      })

      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600)
        const minutes = Math.floor((seconds % 3600) / 60)
        const secs = Math.floor(seconds % 60)
        const ms = Math.floor((seconds % 1) * 1000)
        return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(
          2,
          "0"
        )}:${String(secs).padStart(2, "0")}.${String(ms).padStart(3, "0")}`
      }

      // Custom confirmation dialog
      function showExitWarning() {
        return confirm(
          "转 注 驻注. 爪 祝 转驻住拽 转 转.  转  砖专爪 爪转?"
        )
      }

      window.addEventListener("beforeunload", function (e) {
        if (activeTranscription) {
          // Show confirmation dialog
          e.preventDefault()
          e.returnValue =
            "转 注 驻注. 爪 祝 转驻住拽 转 转.  转  砖专爪 爪转?"
          return e.returnValue
        }
      })

      // Handle refresh key combinations
      window.addEventListener("keydown", function (e) {
        if (
          activeTranscription &&
          (e.key === "F5" || (e.key === "r" && (e.ctrlKey || e.metaKey)))
        ) {
          if (!showExitWarning()) {
            e.preventDefault()
            return false
          }
        }
      })

      // Handle clicks on links
      document.addEventListener("click", function (e) {
        if (!activeTranscription) return

        const link = e.target.closest("a")
        if (link && !link.hasAttribute("download")) {
          if (!showExitWarning()) {
            e.preventDefault()
            return false
          }
        }
      })

      // Toggle between line breaks and spaces for transcription display
      segmentToggle.addEventListener("change", function () {
        if (transcriptionSegments.length > 0) {
          updateTranscriptionDisplay()
        }
      })

      // Toggle for time codes
      timecodeToggle.addEventListener("change", function () {
        if (transcriptionSegments.length > 0) {
          updateTranscriptionDisplay()
        }
      })
    </script>
  </body>
</html>
